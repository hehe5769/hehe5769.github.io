<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åº“å­˜ä¸è´¢åŠ¡ç»Ÿè®¡ç³»ç»Ÿ - Gemma ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 1);
        }

        .badge-large {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-small {
            background-color: #dcfce7;
            color: #166534;
        }

        .total-banner {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen pb-12">

    <div class="max-w-5xl mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“¦ æ™ºèƒ½å•†å“åº“å­˜ä¸é‡‘é¢ç»Ÿè®¡</h1>
            <p class="text-gray-600">æ”¯æŒæœ¬åœ°è‡ªåŠ¨ä¿å­˜ä¸ CSV å¯¼å‡ºã€‚</p>
        </header>

        <div class="glass-card rounded-2xl p-6 shadow-sm mb-8">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-semibold text-gray-700 mb-2">æ™ºèƒ½å½•å…¥ï¼ˆæ”¯æŒè¯­éŸ³è½¬æ–‡å­—ç²˜è´´æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰</label>
                <!-- åŠ è½½æµ‹è¯•æ•°æ®æŒ‰é’® -->
                <button id="loadTestBtn"
                    class="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium px-3 py-1.5 bg-blue-50 rounded-lg border border-blue-100 transition-all hover:shadow-sm">
                    <span>ğŸ’¡</span> åŠ è½½æµ‹è¯•æ•°æ®
                </button>
            </div>

            <textarea id="aiInput" rows="4"
                class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="ä¾‹å¦‚ï¼š3æ¡¶æ— å¶é…¸èœ42æ–¤ï¼Œå•ä»·50å…ƒï¼›5æ¡¶å¤§é¢—å…åˆ‡é…¸èœå•ä»·45å…ƒ..."></textarea>

            <div class="mt-4 flex flex-wrap gap-3 items-center justify-between">
                <div class="flex gap-2">
                    <button id="processBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <span id="btnText">å¼€å§‹ AI è¯†åˆ«</span>
                        <div id="loader"
                            class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin">
                        </div>
                    </button>
                    <button id="clearInputBtn"
                        class="text-gray-500 hover:bg-gray-100 px-4 py-2.5 rounded-lg transition-colors">é‡ç½®è¾“å…¥</button>
                </div>
                <p class="text-xs text-gray-400">* ç³»ç»Ÿä¼šè‡ªåŠ¨åˆå¹¶åŒåä¸”åŒè§„æ ¼çš„å•†å“</p>
            </div>
        </div>

        <div class="glass-card rounded-2xl shadow-sm overflow-hidden mb-6">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                <h2 class="text-xl font-bold text-gray-800">åº“å­˜æ˜ç»†</h2>
                <div class="flex gap-2">
                    <button id="exportCsvBtn"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-md text-sm transition-colors flex items-center gap-1">å¯¼å‡º
                        CSV</button>
                    <button id="resetTableBtn"
                        class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-md text-sm transition-colors">æ¸…ç©ºæœ¬åœ°å­˜å‚¨</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                        <tr>
                            <th class="px-6 py-4 font-semibold">å•†å“åç§°</th>
                            <th class="px-6 py-4 font-semibold text-center">è§„æ ¼</th>
                            <th class="px-6 py-4 font-semibold">æ•°é‡ (æ¡¶)</th>
                            <th class="px-6 py-4 font-semibold">å•ä»· (å…ƒ)</th>
                            <th class="px-6 py-4 font-semibold">å°è®¡ (å…ƒ)</th>
                            <th class="px-6 py-4 font-semibold text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <div id="emptyState" class="py-12 text-center hidden">
                <p class="text-gray-400 text-lg">æš‚æ— æ•°æ®ï¼Œè¯·å°è¯•æ™ºèƒ½è¾“å…¥</p>
            </div>
        </div>

        <div id="summaryCard" class="total-banner rounded-2xl p-6 text-white shadow-xl hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-semibold opacity-90">æ•°æ®å®æ—¶ç»Ÿè®¡</h3>
                    <p class="text-sm opacity-60">æ•°æ®å·²ä¿å­˜è‡³æµè§ˆå™¨æœ¬åœ°</p>
                </div>
                <div class="flex justify-center gap-12 border-x border-white/10">
                    <div class="text-center">
                        <div class="text-xs uppercase tracking-widest opacity-60 mb-1">æ€»å“é¡¹</div>
                        <div id="totalTypes" class="text-3xl font-bold">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs uppercase tracking-widest opacity-60 mb-1">ç´¯è®¡æ¡¶æ•°</div>
                        <div id="totalBuckets" class="text-3xl font-bold">0</div>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <div class="text-xs uppercase tracking-widest opacity-60 mb-1">æ€»è®¡é‡‘é¢ (CNY)</div>
                    <div class="text-4xl font-black text-yellow-400">
                        <span class="text-xl mr-1">Â¥</span><span id="totalAmount">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="statusMsg" class="mt-4 hidden p-4 rounded-xl text-center text-sm font-medium"></div>
    </div>

    <script>
        // é…ç½®åŒº - è¯·ç¡®ä¿ API Key æ­£ç¡®
        const apiKey = "AIzaSyD52sNOXplSIh2yS9QGbzWNymvcFwApkhE";
        const modelId = "gemma-3-27b-it";

        // çŠ¶æ€åˆå§‹åŒ–ï¼šä¼˜å…ˆä» LocalStorage è¯»å–
        let inventory = JSON.parse(localStorage.getItem('inventoryData')) || {};

        const aiInput = document.getElementById('aiInput');
        const processBtn = document.getElementById('processBtn');
        const btnText = document.getElementById('btnText');
        const loader = document.getElementById('loader');
        const inventoryBody = document.getElementById('inventoryBody');
        const emptyState = document.getElementById('emptyState');
        const summaryCard = document.getElementById('summaryCard');
        const statusMsg = document.getElementById('statusMsg');

        // æŒä¹…åŒ–ä¿å­˜
        function saveToLocal() {
            localStorage.setItem('inventoryData', JSON.stringify(inventory));
        }

        // AI æ ¸å¿ƒå‡½æ•°
        async function analyzeTextWithAI(text) {
            const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è´¢åŠ¡ä¸åº“å­˜æå–åŠ©æ‰‹ã€‚
            ä»»åŠ¡ï¼šä»æ–‡æœ¬ä¸­æå–ï¼šname(å“å), weight(å•æ¡¶æ–¤æ•°), quantity(æ¡¶æ•°), price(å•ä»·)ã€‚
            è§„åˆ™ï¼šå¦‚æœå“åå«â€œå¤§é¢—â€ï¼Œæœ«å°¾åŠ â€œã€å¤§é¢—èœã€‘â€ã€‚
            è¾“å‡ºæ ¼å¼ï¼šå¿…é¡»ä¸”ä»…è¿”å›ä¸€ä¸ª JSON æ•°ç»„ï¼Œä¾‹å¦‚: [{"name":"æ— å¶é…¸èœ","weight":42,"quantity":3,"price":50}]ã€‚
            æ–‡æœ¬å†…å®¹ï¼š${text}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.1, maxOutputTokens: 1000 }
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'è¯·æ±‚å¤±è´¥');

                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const match = rawText.match(/\[\s*\{.*\}\s*\]/s);
                if (!match) throw new Error("AI è¿”å›æ ¼å¼éæ ‡å‡† JSON");

                return JSON.parse(match[0]);
            } catch (error) {
                console.error('AI Error:', error);
                showStatus('AI è¯†åˆ«é”™è¯¯: ' + error.message, 'error');
                return null;
            }
        }

        // UI æ¸²æŸ“ä¸æ±‡æ€»
        function updateUI() {
            saveToLocal();
            const keys = Object.keys(inventory);

            if (keys.length === 0) {
                inventoryBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                summaryCard.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            summaryCard.classList.remove('hidden');

            let totalBucketsVal = 0;
            let totalAmountVal = 0;

            inventoryBody.innerHTML = keys.map(key => {
                const item = inventory[key];
                const isLarge = item.weight >= 40;
                const subtotal = item.quantity * item.price;
                totalBucketsVal += item.quantity;
                totalAmountVal += subtotal;

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-400">${item.weight}æ–¤/æ¡¶</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold ${isLarge ? 'badge-large' : 'badge-small'}">
                                ${isLarge ? 'å¤§æ¡¶' : 'å°æ¡¶'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <input type="number" value="${item.quantity}" oninput="updateField('${key}', 'quantity', this.value)"
                                class="w-16 border rounded px-2 py-1 outline-none focus:ring-1 focus:ring-blue-400">
                        </td>
                        <td class="px-6 py-4">
                            <input type="number" step="0.01" value="${item.price}" oninput="updateField('${key}', 'price', this.value)"
                                class="w-20 border rounded px-2 py-1 outline-none focus:ring-1 focus:ring-blue-400">
                        </td>
                        <td class="px-6 py-4 font-mono font-bold">Â¥${subtotal.toFixed(2)}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="removeItem('${key}')" class="text-red-300 hover:text-red-500 transition-colors">åˆ é™¤</button>
                        </td>
                    </tr>`;
            }).join('');

            document.getElementById('totalTypes').textContent = keys.length;
            document.getElementById('totalBuckets').textContent = totalBucketsVal;
            document.getElementById('totalAmount').textContent = totalAmountVal.toLocaleString('zh-CN', { minimumFractionDigits: 2 });
        }

        // å­—æ®µæ›´æ–°
        // å­—æ®µæ›´æ–°ï¼šä¼˜åŒ–ç‰ˆï¼Œä¸è§¦å‘å…¨é‡é‡ç»˜
        function updateField(key, field, val) {
            const n = parseFloat(val) || 0;
            inventory[key][field] = n;

            // 1. åªæ›´æ–°å½“å‰è¡Œçš„å°è®¡
            const rowTotal = inventory[key].quantity * inventory[key].price;
            // æ‰¾åˆ°å½“å‰è¾“å…¥æ¡†æ‰€åœ¨çš„è¡Œ
            const inputEl = event.target;
            const row = inputEl.closest('tr');
            const subtotalEl = row.querySelector('td:nth-child(5)');
            if (subtotalEl) {
                subtotalEl.textContent = `Â¥${rowTotal.toFixed(2)}`;
            }

            // 2. æ›´æ–°åº•éƒ¨çš„æ€»è®¡å¡ç‰‡ï¼ˆä¸é‡ç»˜è¡¨æ ¼ï¼‰
            refreshSummaryOnly();

            // 3. å¼‚æ­¥ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸å½±å“è¾“å…¥ä½“éªŒ
            saveToLocal();
        }

        // ä¸“é—¨ç”¨äºå±€éƒ¨æ›´æ–°æ€»è®¡æ•°å€¼
        function refreshSummaryOnly() {
            const keys = Object.keys(inventory);
            let totalBucketsVal = 0;
            let totalAmountVal = 0;

            keys.forEach(key => {
                totalBucketsVal += (inventory[key].quantity || 0);
                totalAmountVal += (inventory[key].quantity * inventory[key].price || 0);
            });

            document.getElementById('totalTypes').textContent = keys.length;
            document.getElementById('totalBuckets').textContent = totalBucketsVal;
            document.getElementById('totalAmount').textContent = totalAmountVal.toLocaleString('zh-CN', { minimumFractionDigits: 2 });
        }

        // åˆ é™¤é¡¹
        function removeItem(key) {
            delete inventory[key];
            updateUI();
        }

        // çŠ¶æ€æç¤º
        function showStatus(msg, type) {
            statusMsg.textContent = msg;
            statusMsg.className = `mt-4 p-4 rounded-xl text-center text-sm block ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            setTimeout(() => statusMsg.classList.add('hidden'), 5000);
        }

        const elements = {
            aiInput: document.getElementById('aiInput')
        };

        document.getElementById('loadTestBtn').addEventListener('click', () => {
            const testData = `é‡‘ï¼Œ178952-1114ï¼Œæ±Ÿè‹çœè‹å·å¸‚å¤ªï¼ˆ1æ¡¶å°æ¡¶34æ–¤é…¸èåœè´´ã€é…¸èåœæ ‡ç­¾ã€‘ï¼‰
ç¿ï¼Œ1848012713ï¼Œç¦å»ºçœç¦å·å¸‚å¹³æ½­å¿æ½­ï¼Œç”µè¯1350ï¼ˆ2æ¡¶å°å¶é…¸èœ42æ–¤è´´æ–°åº—æ ‡ç­¾ï¼‰
æµ™æ±Ÿçœè·¯1å·ï¼ˆå†œ85è‹±ä¹ï¼‰ï¼ˆ1æ¡¶å°å¶é…¸èœ42æ–¤è´´æ–°åº—æ ‡ç­¾ï¼‰
é‡‘å§—ï¼Œ15786408-1552ï¼Œæµ™æ±Ÿæ±Ÿå£è¡—ï¼ˆ10æ¡¶å°å¶é…¸èœ42æ–¤è´´æ–°åº—æ ‡ç­¾ï¼‰
èƒ¡ï¼Œ18413-2443ï¼Œæµ™æ±Ÿçœæ²³cocoæ¢é¢ï¼ˆä¸è¦æ”¾å¿«é€’æŸœï¼‰ï¼ˆ1æ¡¶å°å¶é…¸èœ34æ–¤è´´æ–°åº—æ ‡ç­¾ï¼‰
ç‹ï¼Œ184663653ï¼Œå¹¿ä¸œçœæ—©ä¸­æ™šé¤ï¼ˆ3æ¡¶å°å¶é…¸èœ42æ–¤ã€å¤§é¢—èœã€‘è´´æ–°åº—æ ‡ç­¾ï¼‰
å°¹ï¼Œ17854163892ï¼Œå±±ä¸œçœæµå—å·çƒ¤é±¼åº—ï¼ˆ1æ¡¶å¤§æ¡¶40æ–¤é…¸èåœè´´ã€é…¸èåœæ ‡ç­¾ã€‘ğŸ”¥ï¼‰
çŸ³ï¼Œ1754961933ï¼Œå‰æ—çœå‰æ—å¸‚é¾™ï¼ˆ2æ¡¶å°å¶é…¸èœ42æ–¤è´´æ–°åº—æ ‡ç­¾ï¼‰`;

            elements.aiInput.value = testData;
            showStatus('å·²å¡«å…¥æµ‹è¯•æ ·ä¾‹æ–‡æœ¬', 'success');
        });
        // æŒ‰é’®ç›‘å¬
        processBtn.addEventListener('click', async () => {
            const text = aiInput.value.trim();
            if (!text) return;

            // --- æ–°å¢é€»è¾‘ï¼šç‚¹å‡»è¯†åˆ«æ—¶å…ˆæ¸…ç©ºæ—§åº“å­˜å’Œæœ¬åœ°å­˜å‚¨ ---
            if (Object.keys(inventory).length > 0) {
                inventory = {}; // æ¸…ç©ºå†…å­˜æ•°æ®
                localStorage.removeItem('inventoryData'); // æ¸…ç©ºæœ¬åœ°ç¼“å­˜
                updateUI(); // æ¸²æŸ“ç©ºç•Œé¢
            }

            processBtn.disabled = true;
            loader.classList.remove('hidden');
            btnText.textContent = 'è¯†åˆ«ä¸­...';

            const results = await analyzeTextWithAI(text);
            if (results) {
                results.forEach(item => {
                    // ç”Ÿæˆå”¯ä¸€é”®ï¼šå“å + è§„æ ¼(L/S)
                    const key = `${item.name}-${item.weight >= 40 ? 'L' : 'S'}`;

                    // å› ä¸ºä¸Šé¢å·²ç»æ¸…ç©ºäº†ï¼Œè¿™é‡Œå…¶å®ç›´æ¥èµ‹å€¼å³å¯ï¼Œ
                    // ä½†ä¿ç•™é€»è¾‘åˆ¤æ–­å¯ä»¥å…¼å®¹æœªæ¥â€œè¿½åŠ æ¨¡å¼â€çš„æ‰©å±•
                    if (inventory[key]) {
                        inventory[key].quantity += item.quantity;
                        if (item.price > 0) inventory[key].price = item.price;
                    } else {
                        inventory[key] = item;
                    }
                });
                aiInput.value = '';
                updateUI(); // è¯†åˆ«å®Œæˆåç»Ÿä¸€æ¸²æŸ“
                showStatus('æ–°æ•°æ®å·²æ ¸ç®—å®Œæˆ', 'success');
            }
            processBtn.disabled = false;
            loader.classList.add('hidden');
            btnText.textContent = 'å¼€å§‹ AI è¯†åˆ«';
        });
        document.getElementById('clearInputBtn').addEventListener('click', () => aiInput.value = '');
        document.getElementById('resetTableBtn').addEventListener('click', () => {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„æ•°æ®å—ï¼Ÿ')) {
                inventory = {};
                updateUI();
            }
        });

        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            const keys = Object.keys(inventory);
            if (keys.length === 0) return;
            let csv = "\uFEFFå“å,é‡é‡,è§„æ ¼,æ•°é‡,å•ä»·,å°è®¡\n";
            keys.forEach(k => {
                const i = inventory[k];
                csv += `"${i.name}",${i.weight},${i.weight >= 40 ? 'å¤§æ¡¶' : 'å°æ¡¶'},${i.quantity},${i.price},${(i.quantity * i.price).toFixed(2)}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åº“å­˜ç»Ÿè®¡_${new Date().toLocaleDateString()}.csv`;
            a.click();
        });

        // é¦–æ¬¡åŠ è½½æ¸²æŸ“
        updateUI();
    </script>
</body>

</html>