<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å•†å“åº“å­˜ä¸é‡‘é¢ç»Ÿè®¡ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 1);
        }

        .badge-large {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-small {
            background-color: #dcfce7;
            color: #166534;
        }

        .total-banner {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen pb-12">

    <div class="max-w-5xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“¦ æ™ºèƒ½å•†å“åº“å­˜ä¸é‡‘é¢ç»Ÿè®¡</h1>
            <p class="text-gray-600">è‡ªåŠ¨è¯†åˆ«è§„æ ¼ä¸å±æ€§ï¼Œæ”¯æŒå•ä»·è®¾ç½®ã€é‡‘é¢ç»“ç®—åŠ CSV å¯¼å‡ºã€‚</p>
        </header>

        <!-- AI Input Section -->
        <div class="glass-card rounded-2xl p-6 shadow-sm mb-8">
            <label class="block text-sm font-semibold text-gray-700 mb-2">æ™ºèƒ½è¾“å…¥æ¡†</label>
            <textarea id="aiInput" rows="4"
                class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                placeholder="ä¾‹å¦‚ï¼š3æ¡¶æ— å¶é…¸èœ42æ–¤ï¼Œå•ä»·50å…ƒï¼›5æ¡¶å…åˆ‡é…¸èœå•ä»·45å…ƒ..."></textarea>

            <div class="mt-4 flex flex-wrap gap-3 items-center justify-between">
                <div class="flex gap-2">
                    <button id="processBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <span id="btnText">å¼€å§‹ AI è¯†åˆ«</span>
                        <div id="loader"
                            class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin">
                        </div>
                    </button>
                    <button id="clearInputBtn"
                        class="text-gray-500 hover:bg-gray-100 px-4 py-2.5 rounded-lg transition-colors">
                        é‡ç½®è¾“å…¥
                    </button>
                </div>
                <p class="text-xs text-gray-400">* å¡«å†™å•ä»·å¯è‡ªåŠ¨è®¡ç®—é‡‘é¢</p>
            </div>
        </div>

        <!-- Dashboard / Table Section -->
        <div class="glass-card rounded-2xl shadow-sm overflow-hidden mb-6">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                <h2 class="text-xl font-bold text-gray-800">åº“å­˜æ˜ç»†</h2>
                <div class="flex gap-2">
                    <button id="exportCsvBtn"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-md text-sm transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        å¯¼å‡º CSV
                    </button>
                    <button id="resetTableBtn"
                        class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-md text-sm transition-colors">
                        æ¸…ç©ºæ•°æ®è¡¨
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                        <tr>
                            <th class="px-6 py-4 font-semibold">å•†å“åç§°</th>
                            <th class="px-6 py-4 font-semibold text-center">è§„æ ¼</th>
                            <th class="px-6 py-4 font-semibold">æ•°é‡ (æ¡¶)</th>
                            <th class="px-6 py-4 font-semibold">å•ä»· (å…ƒ)</th>
                            <th class="px-6 py-4 font-semibold">å°è®¡ (å…ƒ)</th>
                            <th class="px-6 py-4 font-semibold text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody" class="divide-y divide-gray-100">
                        <!-- Data rows will appear here -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="py-12 text-center">
                <p class="text-gray-400 text-lg">æš‚æ— æ•°æ®ï¼Œè¯·å°è¯•æ™ºèƒ½è¾“å…¥</p>
            </div>
        </div>

        <!-- Total Summary Footer -->
        <div id="summaryCard" class="total-banner rounded-2xl p-6 text-white shadow-xl hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-semibold opacity-90">æ•°æ®å®æ—¶ç»Ÿè®¡</h3>
                    <p class="text-sm opacity-60">Inventory & Financial Summary</p>
                </div>

                <div class="flex justify-center gap-12 border-x border-white/10">
                    <div class="text-center">
                        <div class="text-xs uppercase tracking-widest opacity-60 mb-1">æ€»å“é¡¹</div>
                        <div id="totalTypes" class="text-3xl font-bold italic">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs uppercase tracking-widest opacity-60 mb-1">ç´¯è®¡æ¡¶æ•°</div>
                        <div id="totalBuckets" class="text-3xl font-bold italic">0</div>
                    </div>
                </div>

                <div class="text-center md:text-right">
                    <div class="text-xs uppercase tracking-widest opacity-60 mb-1">æ€»è®¡é‡‘é¢ (CNY)</div>
                    <div class="text-4xl font-black text-yellow-400">
                        <span class="text-xl mr-1">Â¥</span><span id="totalAmount">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Info -->
        <div id="statusMsg" class="mt-4 hidden p-4 rounded-xl text-center text-sm font-medium"></div>
    </div>

    <script>
        const apiKey = "AIzaSyD52sNOXplSIh2yS9QGbzWNymvcFwApkhE";
        let inventory = {};

        const aiInput = document.getElementById('aiInput');
        const inventoryBody = document.getElementById('inventoryBody');
        const emptyState = document.getElementById('emptyState');
        const clearInputBtn = document.getElementById('clearInputBtn');
        const resetTableBtn = document.getElementById('resetTableBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const statusMsg = document.getElementById('statusMsg');

        const summaryCard = document.getElementById('summaryCard');
        const totalTypes = document.getElementById('totalTypes');
        const totalBuckets = document.getElementById('totalBuckets');
        const totalAmount = document.getElementById('totalAmount');

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        // async function analyzeTextWithAI(text) {
        //     if (!apiKey && typeof __initial_auth_token === 'undefined') {
        //         showStatus('æç¤ºï¼šAPI Key æœªé…ç½®ã€‚è¯·åœ¨ä»£ç å¤´éƒ¨æˆ–ç¯å¢ƒä¸­è®¾ç½®ã€‚', 'error');
        //         return null;
        //     }

        //     const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åº“å­˜ä¸è´¢åŠ¡æå–åŠ©æ‰‹ã€‚è¯·ä»ç”¨æˆ·æè¿°ä¸­æå–ï¼š
        //     1. name (å•†å“å): å¦‚æœæœ‰â€œå¤§é¢—â€å­—æ ·ï¼Œæœ«å°¾åŠ â€œã€å¤§é¢—èœã€‘â€ã€‚â€œæ— å¶â€ã€â€œå…åˆ‡â€åº”ä½œä¸ºç‹¬ç«‹å“é¡¹ã€‚
        //     2. weight (é‡é‡): æ•°å­—ã€‚
        //     3. quantity (æ¡¶æ•°): æ•´æ•°ã€‚
        //     4. price (å•ä»·): è¯†åˆ«å•ä»·ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™é»˜è®¤ä¸º 0ã€‚

        //     è¾“å‡ºæ ¼å¼å¿…é¡»ä¸º JSON æ•°ç»„: [{"name": "å“å", "weight": æ•°å­—, "quantity": æ•°å­—, "price": æ•°å­—}]ã€‚
        //     åªè¿”å› JSON æ•°ç»„ï¼Œä¸¥ç¦å…¶ä»–è§£é‡Šæ€§æ–‡å­—ã€‚`;

        //     // å»ºè®®ä½¿ç”¨ Flash-Lite ä»¥è·å¾—æ›´å¤šå…è´¹æ¬¡æ•°ï¼ˆè™½ç„¶æˆªå›¾æ˜¾ç¤ºä¹Ÿæ˜¯20ï¼Œä½†åœ¨APIè°ƒç”¨ä¸­é€šå¸¸æ›´å®½æ¾ï¼‰
        //     // å»ºè®®å…ˆå°è¯•è¿™ä¸ªæœ€ç¨³å®šçš„ ID
        //     // ä¿®æ”¹åçš„ URL æŒ‡å‘ gemma-3-12b
        //     const url = `https://generativelanguage.googleapis.com/v1beta/models/gemma-3-12b-it:generateContent?key=${apiKey}`;

        //     try {
        //         const data = await fetchWithRetry(url, {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json' },
        //             body: JSON.stringify({
        //                 contents: [{ parts: [{ text: text }] }],
        //                 systemInstruction: { parts: [{ text: systemPrompt }] },
        //                 generationConfig: {
        //                     responseMimeType: "application/json",
        //                     temperature: 0.1
        //                 }
        //             })
        //         });

        //         const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        //         return JSON.parse(resultText);
        //     } catch (error) {
        //         console.error('AI Error:', error);
        //         showStatus('ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•è¿æ¥ AI æœåŠ¡', 'error');
        //         return null;
        //     }
        // }
        async function analyzeTextWithAI(text) {
            // å¼ºåˆ¶è¦æ±‚è¾“å‡ºæ ¼å¼ï¼Œå¹¶æé†’ä¸è¦åºŸè¯
            const prompt = `Task: Extract inventory data to JSON array.
    Format: [{"name": "string", "weight": number, "quantity": number, "price": number}]
    Rules: If "å¤§é¢—" in name, add "ã€å¤§é¢—èœã€‘".
    Data to process: ${text}
    Important: Output ONLY the raw JSON array starting with [ and ending with ]. No explanation.`;

            // åˆ‡æ¢åˆ°æ€§èƒ½æ›´å¼ºçš„ 27b
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.1, // é™ä½éšæœºæ€§ï¼Œä½¿æ ¼å¼æ›´å›ºå®š
                            maxOutputTokens: 1000 // é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé˜²æ­¢ Token æº¢å‡ºå¯¼è‡´çš„ä»»åŠ¡ä¸­æ–­
                        }
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                let resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                // --- å¼ºåŠ›æå– JSON æ•°ç»„ ---
                const start = resultText.indexOf('[');
                const end = resultText.lastIndexOf(']');

                if (start === -1 || end === -1) {
                    throw new Error("AI è¿”å›å†…å®¹ä¸åŒ…å«æœ‰æ•ˆçš„ JSON æ•°ç»„");
                }

                const cleanJson = resultText.substring(start, end + 1);
                return JSON.parse(cleanJson);
            } catch (error) {
                console.error('Error:', error);
                showStatus('è¯†åˆ«å¤±è´¥ï¼š' + error.message, 'error');
                return null;
            }
        }


        function calculateSummary() {
            const keys = Object.keys(inventory);
            let totalQty = 0;
            let totalSum = 0;

            keys.forEach(key => {
                const item = inventory[key];
                totalQty += (item.quantity || 0);
                totalSum += (item.quantity * item.price);
            });

            if (keys.length > 0) {
                summaryCard.classList.remove('hidden');
                totalTypes.textContent = keys.length;
                totalBuckets.textContent = totalQty;
                totalAmount.textContent = totalSum.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                summaryCard.classList.add('hidden');
            }
        }

        function updateUI() {
            const keys = Object.keys(inventory);
            if (keys.length === 0) {
                inventoryBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                calculateSummary();
                return;
            }

            emptyState.classList.add('hidden');
            inventoryBody.innerHTML = keys.map(key => {
                const item = inventory[key];
                const isLarge = item.weight >= 40;
                const badgeClass = isLarge ? 'badge-large' : 'badge-small';
                const rowTotal = (item.quantity * item.price).toFixed(2);

                return `
                    <tr class="hover:bg-blue-50/50 transition-colors border-b border-gray-100 last:border-0">
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-400">${item.weight > 0 ? item.weight + 'æ–¤/æ¡¶' : 'é‡é‡æœªæ ‡'}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${badgeClass}">
                                ${isLarge ? 'å¤§æ¡¶' : 'å°æ¡¶'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <input type="number" value="${item.quantity}" 
                                oninput="updateField('${key}', 'quantity', this.value)"
                                class="w-16 bg-white border border-gray-200 rounded px-2 py-1 focus:ring-1 focus:ring-blue-400 outline-none">
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <span class="text-gray-400 mr-1 text-sm">Â¥</span>
                                <input type="number" step="0.01" value="${item.price}" 
                                    oninput="updateField('${key}', 'price', this.value)"
                                    class="w-20 bg-white border border-gray-200 rounded px-2 py-1 focus:ring-1 focus:ring-blue-400 outline-none">
                            </div>
                        </td>
                        <td class="px-6 py-4 font-mono font-bold text-gray-700">
                            Â¥${rowTotal}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="removeItem('${key}')" class="text-red-300 hover:text-red-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            calculateSummary();
        }

        function updateField(key, field, val) {
            const num = parseFloat(val);
            if (isNaN(num) || num < 0) return;
            inventory[key][field] = num;
            calculateSummary();
            const rowTotalEl = document.querySelector(`tr:has(input[oninput*="'${key}'"]) td:nth-child(5)`);
            if (rowTotalEl) {
                rowTotalEl.textContent = `Â¥${(inventory[key].quantity * inventory[key].price).toFixed(2)}`;
            }
        }

        function removeItem(key) {
            delete inventory[key];
            updateUI();
            showStatus(`å·²ç§»é™¤å•†å“é¡¹`, 'info');
        }

        function showStatus(msg, type) {
            statusMsg.textContent = msg;
            statusMsg.className = `mt-4 p-4 rounded-xl text-center text-sm block `;
            if (type === 'success') statusMsg.classList.add('bg-green-100', 'text-green-700');
            else if (type === 'error') statusMsg.classList.add('bg-red-100', 'text-red-700');
            else statusMsg.classList.add('bg-blue-100', 'text-blue-700');
            setTimeout(() => statusMsg.classList.add('hidden'), 5000);
        }

        function exportCSV() {
            const keys = Object.keys(inventory);
            if (keys.length === 0) return showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');

            let csvContent = "\uFEFF"; // UTF-8 BOM for Excel
            csvContent += "å•†å“åç§°,è§„æ ¼ç±»å‹,é‡é‡(æ–¤),æ•°é‡(æ¡¶),å•ä»·(å…ƒ),å°è®¡(å…ƒ)\n";

            keys.forEach(key => {
                const item = inventory[key];
                const type = item.weight >= 40 ? "å¤§æ¡¶" : "å°æ¡¶";
                const total = (item.quantity * item.price).toFixed(2);
                csvContent += `"${item.name}","${type}",${item.weight},${item.quantity},${item.price},${total}\n`;
            });

            // Add total row
            let totalQty = 0;
            let totalSum = 0;
            keys.forEach(k => {
                totalQty += inventory[k].quantity;
                totalSum += (inventory[k].quantity * inventory[k].price);
            });
            csvContent += `\n"æ€»è®¡",,,${totalQty},,"${totalSum.toFixed(2)}"\n`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().slice(0, 10);

            link.setAttribute("href", url);
            link.setAttribute("download", `åº“å­˜æ˜ç»†_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('CSV æ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½', 'success');
        }

        processBtn.addEventListener('click', async () => {
            const text = aiInput.value.trim();
            if (!text) return showStatus('è¯·è¾“å…¥æ–‡å­—å†…å®¹', 'error');

            processBtn.disabled = true;
            btnText.textContent = 'AI æ­£åœ¨æ ¸ç®—ä¸­...';
            loader.classList.remove('hidden');

            const results = await analyzeTextWithAI(text);

            if (results && Array.isArray(results)) {
                results.forEach(item => {
                    const isLarge = item.weight >= 40;
                    const typeKey = `${item.name}-${isLarge ? 'L' : 'S'}`;

                    if (inventory[typeKey]) {
                        inventory[typeKey].quantity += item.quantity;
                        if (item.price > 0 && inventory[typeKey].price === 0) {
                            inventory[typeKey].price = item.price;
                        }
                    } else {
                        inventory[typeKey] = item;
                    }
                });
                updateUI();
                aiInput.value = '';
                showStatus('è¯†åˆ«å¹¶æ±‡æ€»æ ¸ç®—å®Œæˆï¼', 'success');
            }

            processBtn.disabled = false;
            btnText.textContent = 'å¼€å§‹ AI è¯†åˆ«';
            loader.classList.add('hidden');
        });

        clearInputBtn.addEventListener('click', () => aiInput.value = '');
        resetTableBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                inventory = {};
                updateUI();
                showStatus('æ•°æ®å·²é‡ç½®', 'info');
            }
        });

        exportCsvBtn.addEventListener('click', exportCSV);

        updateUI();
    </script>
</body>

</html>