<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­AIé«˜æ•ˆå­¦ä¹ å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
        }

        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .card-back {
            transform: rotateY(180deg);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div id="app" class="max-w-md mx-auto p-4 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="flex justify-between items-center py-4">
            <div>
                <h1 class="text-xl font-bold text-gray-800">é«˜æ•ˆèƒŒè¯</h1>
                <p id="statsDisplay" class="text-xs text-gray-500 font-medium">å·²æŒæ¡: 0 | å¾…åŠ å¼º: 0</p>
            </div>
            <div class="flex gap-2">
                <select id="levelSelect" class="bg-white border rounded-lg px-2 py-1 text-sm shadow-sm">
                    <option value="N1">JLPT N1</option>
                    <option value="N2" selected>JLPT N2</option>
                </select>
                <button id="showHistory" class="p-2 bg-white rounded-lg shadow-sm">ğŸ“Š</button>
            </div>
        </header>

        <!-- Progress Container -->
        <div class="mb-6">
            <div class="flex justify-between text-[10px] text-gray-400 mb-1 px-1">
                <span>å½“å‰è¿›åº¦</span>
                <span id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 h-1 rounded-full">
                <div id="progressBar" class="bg-indigo-500 h-1 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>
        </div>

        <!-- Main Flashcard Area -->
        <div id="studyView" class="flex-1 flex flex-col">
            <div id="cardContainer" class="word-card w-full aspect-[3/4] mb-8 group">
                <div class="card-inner relative w-full h-full shadow-2xl rounded-3xl bg-white">

                    <!-- Front (Active Recall) -->
                    <div
                        class="card-face card-front absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
                        <span class="text-xs text-gray-300 mb-4 uppercase tracking-widest">æ€è€ƒå…¶ä¸­æ–‡å«ä¹‰</span>
                        <div id="frontWord" class="text-6xl font-bold text-slate-800">...</div>
                        <div class="mt-12 text-indigo-500 animate-bounce">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm mt-2">ç‚¹å‡»ç¿»è½¬å¡ç‰‡</p>
                    </div>

                    <!-- Back (The Answer) -->
                    <div
                        class="card-face card-back absolute inset-0 flex flex-col p-6 bg-white rounded-3xl overflow-y-auto">
                        <div id="backFurigana" class="text-indigo-500 text-lg font-medium text-center mb-1"></div>
                        <div id="backWord" class="text-4xl font-bold text-slate-800 text-center mb-4 border-b pb-4">
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h4 class="text-xs font-bold text-gray-400 uppercase">é‡Šä¹‰</h4>
                                <p id="meaning" class="text-xl text-slate-700 leading-tight"></p>
                            </div>

                            <div class="bg-indigo-50 p-4 rounded-2xl">
                                <h4 class="text-xs font-bold text-indigo-300 uppercase mb-2">AI ä¾‹å¥</h4>
                                <p id="exJp" class="text-slate-800 mb-2 leading-relaxed font-medium"></p>
                                <p id="exCn" class="text-slate-500 text-sm"></p>
                            </div>
                        </div>

                        <button id="speakBtn"
                            class="mt-auto self-center p-3 rounded-full bg-indigo-100 text-indigo-600 mb-2">
                            ğŸ”Š æ’­æ”¾å‘éŸ³
                        </button>
                    </div>

                </div>
            </div>

            <!-- Learning Actions (Shown only when flipped) -->
            <div id="controlGroup"
                class="grid grid-cols-2 gap-4 opacity-0 pointer-events-none transition-opacity duration-300">
                <button id="failBtn"
                    class="flex flex-col items-center justify-center py-4 bg-red-50 text-red-600 rounded-2xl border-2 border-red-100 hover:bg-red-100">
                    <span class="text-xl font-bold">å¿˜äº†</span>
                    <span class="text-[10px]">é‡æ–°å­¦ä¹ </span>
                </button>
                <button id="passBtn"
                    class="flex flex-col items-center justify-center py-4 bg-emerald-50 text-emerald-600 rounded-2xl border-2 border-emerald-100 hover:bg-emerald-100">
                    <span class="text-xl font-bold">è®¤è¯†</span>
                    <span class="text-[10px]">ä¸‹ä¸€å¼ </span>
                </button>
            </div>
        </div>

        <!-- Notebook View -->
        <section id="historyView" class="hidden flex-1">
            <div class="flex items-center justify-between mb-6">
                <button id="backBtn" class="text-indigo-600 font-bold flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                            clip-rule="evenodd" />
                    </svg> è¿”å›å­¦ä¹ 
                </button>
                <h2 class="font-bold text-gray-800">æ”¶è—å¤¹ / éš¾è¯æœ¬</h2>
                <button id="clearBtn" class="text-xs text-red-400">æ¸…ç©º</button>
            </div>
            <div id="historyList" class="space-y-3"></div>
        </section>
    </div>

    <!-- Loading State -->
    <div id="globalLoader" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
        <p class="mt-4 text-indigo-600 font-medium tracking-widest">AI è€å¸ˆæ­£åœ¨å‡†å¤‡å•è¯...</p>
    </div>

    <script type="module">
        const apiKey = "AIzaSyD52sNOXplSIh2yS9QGbzWNymvcFwApkhE";

        const dictionary = {
            N2: ["åŠ¹ç‡", "æ™®åŠ", "è²¢çŒ®", "åæ˜ ", "å…‹æœ", "çŸ›ç›¾", "ç¶­æŒ", "æ…é‡", "è¬™è™š", "è¿…é€Ÿ", "å¦¥å”", "æŠŠæ¡"],
            N1: ["ä¸€èº", "ç•æ€–", "å©‰æ›²", "ä¹–é›¢", "æ¦‚å¿µ", "äº«å—", "çœŸé«„", "è„†å¼±", "é‚„å…ƒ", "æ¯…ç„¶", "æ‡¸å¿µ", "å¸Œè–„"]
        };

        let state = {
            level: 'N2',
            currentWord: null,
            isFlipped: false,
            // å­˜å‚¨ç»“æ„ï¼š{ word, status: 'mastered' | 'learning', data }
            records: JSON.parse(localStorage.getItem('jp_pro_records') || '{}'),
            sessionCount: 0
        };

        const els = {
            container: document.getElementById('cardContainer'),
            studyView: document.getElementById('studyView'),
            historyView: document.getElementById('historyView'),
            frontWord: document.getElementById('frontWord'),
            backWord: document.getElementById('backWord'),
            backFurigana: document.getElementById('backFurigana'),
            meaning: document.getElementById('meaning'),
            exJp: document.getElementById('exJp'),
            exCn: document.getElementById('exCn'),
            controls: document.getElementById('controlGroup'),
            passBtn: document.getElementById('passBtn'),
            failBtn: document.getElementById('failBtn'),
            loader: document.getElementById('globalLoader'),
            stats: document.getElementById('statsDisplay'),
            progress: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            historyList: document.getElementById('historyList'),
            level: document.getElementById('levelSelect')
        };

        async function fetchWordAI(word) {
            const prompt = `ä½ æ˜¯ä¸€ä¸ªæ—¥è¯­ä¸“å®¶ã€‚è¯·å¯¹å•è¯ "${word}" è¿”å›ä»¥ä¸‹ JSON æ ¼å¼çš„å†…å®¹ï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–è§£é‡Šæ–‡å­—ï¼š
    {"furigana": "å•è¯çš„å‡å", "meaning": "ä¸­æ–‡å«ä¹‰", "exampleJp": "åœ°é“çš„æ—¥æ–‡ä¾‹å¥", "exampleCn": "ä¾‹å¥çš„ä¸­æ–‡ç¿»è¯‘"}`;

            try {
                // ä½¿ç”¨é¢åº¦æœ€å……è¶³çš„ Gemma 3 27B æ¨¡å‹
                // æ¥å£è·¯å¾„å¿…é¡»ä½¿ç”¨ v1betaï¼Œå› ä¸º Gemma æ¨¡å‹å±äºå®éªŒæ€§/è¾ƒæ–°æ¨¡å‹
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            // Gemma æœ‰æ—¶æ¯”è¾ƒè¯å¤šï¼Œå¼ºåˆ¶è®¾ç½® temperature è¾ƒä½ä»¥è·å¾—æ›´ç¨³å®šçš„ JSON
                            temperature: 0.1,
                            topP: 0.95,
                            maxOutputTokens: 200
                        }
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error("Gemma API æŠ¥é”™:", result);
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} - ${result.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                // æå–æ–‡æœ¬å¹¶æ¸…ç† JSON
                let text = result.candidates[0].content.parts[0].text;

                // Gemma å¯èƒ½ä¼šè¾“å‡º Markdown æ ¼å¼ï¼Œè¿™é‡Œåšå¼ºåŠ›æ¸…ç†
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error("æœªèƒ½è§£æåˆ°åˆæ³•çš„ JSON æ ¼å¼");
                }

            } catch (err) {
                console.error("æ•æ‰åˆ°é”™è¯¯:", err);
                return {
                    furigana: "ã‚¨ãƒ©ãƒ¼",
                    meaning: "Gemma å“åº”å¼‚å¸¸",
                    exampleJp: "è¯·æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æŠ¥ 403 æˆ–æ¨¡å‹åé”™è¯¯ã€‚",
                    exampleCn: "å¦‚æœ 27b ä¸è¡Œï¼Œå¯ä»¥å°è¯•æ¢æˆ gemma-3-12b-it"
                };
            }
        }





        async function nextWord() {
            state.isFlipped = false;
            els.container.classList.remove('card-flipped');
            els.controls.classList.add('opacity-0', 'pointer-events-none');
            els.loader.classList.remove('hidden');

            // æ™ºèƒ½é€‰æ‹©é€»è¾‘ï¼š40% å‡ ç‡å‡ºç°ä¹‹å‰â€œå¿˜äº†â€çš„è¯
            const learningWords = Object.keys(state.records).filter(k => state.records[k].status === 'learning');
            let word;
            if (learningWords.length > 0 && Math.random() < 0.4) {
                word = learningWords[Math.floor(Math.random() * learningWords.length)];
            } else {
                const list = dictionary[state.level];
                word = list[Math.floor(Math.random() * list.length)];
            }

            const data = await fetchWordAI(word);
            state.currentWord = { word, ...data };

            // Render
            els.frontWord.textContent = word;
            els.backWord.textContent = word;
            els.backFurigana.textContent = data.furigana;
            els.meaning.textContent = data.meaning;
            els.exJp.textContent = data.exampleJp;
            els.exCn.textContent = data.exampleCn;

            els.loader.classList.add('hidden');
            updateUI();
        }

        function handleFeedback(isPositive) {
            const word = state.currentWord.word;
            state.records[word] = {
                status: isPositive ? 'mastered' : 'learning',
                data: state.currentWord,
                timestamp: Date.now()
            };
            localStorage.setItem('jp_pro_records', JSON.stringify(state.records));
            state.sessionCount++;
            nextWord();
        }

        function updateUI() {
            const all = Object.values(state.records);
            const mastered = all.filter(r => r.status === 'mastered').length;
            const learning = all.filter(r => r.status === 'learning').length;
            els.stats.textContent = `å·²æŒæ¡: ${mastered} | å¾…åŠ å¼º: ${learning}`;

            const progress = Math.min((state.sessionCount / 10) * 100, 100);
            els.progress.style.width = `${progress}%`;
            els.progressText.textContent = `${Math.round(progress)}% (æœ¬æ¬¡ä»»åŠ¡)`;
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            const learningOnes = Object.values(state.records).filter(r => r.status === 'learning');

            if (learningOnes.length === 0) {
                els.historyList.innerHTML = '<div class="text-center py-10 text-gray-400">ç›®å‰æ²¡æœ‰éš¾è¯ï¼Œå¤ªæ£’äº†ï¼</div>';
                return;
            }

            learningOnes.sort((a, b) => b.timestamp - a.timestamp).forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-bold text-lg">${item.data.word}</span>
                            <span class="text-xs text-indigo-500 ml-2">${item.data.furigana}</span>
                            <p class="text-sm text-gray-600 mt-1">${item.data.meaning}</p>
                        </div>
                        <button class="text-gray-300 hover:text-red-500" onclick="window.deleteRecord('${item.data.word}')">âœ•</button>
                    </div>
                `;
                els.historyList.appendChild(div);
            });
        }

        // --- Listeners ---
        els.container.addEventListener('click', () => {
            if (!state.isFlipped) {
                state.isFlipped = true;
                els.container.classList.add('card-flipped');
                els.controls.classList.remove('opacity-0', 'pointer-events-none');
            }
        });

        els.passBtn.addEventListener('click', (e) => { e.stopPropagation(); handleFeedback(true); });
        els.failBtn.addEventListener('click', (e) => { e.stopPropagation(); handleFeedback(false); });

        document.getElementById('speakBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const u = new SpeechSynthesisUtterance(state.currentWord.word);
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
        });

        document.getElementById('showHistory').addEventListener('click', () => {
            renderHistory();
            els.studyView.classList.add('hidden');
            els.historyView.classList.remove('hidden');
        });

        document.getElementById('backBtn').addEventListener('click', () => {
            els.historyView.classList.add('hidden');
            els.studyView.classList.remove('hidden');
        });

        els.level.addEventListener('change', (e) => {
            state.level = e.target.value;
            nextWord();
        });

        window.deleteRecord = (word) => {
            delete state.records[word];
            localStorage.setItem('jp_pro_records', JSON.stringify(state.records));
            renderHistory();
            updateUI();
        };

        // Init
        nextWord();
    </script>
</body>

</html>