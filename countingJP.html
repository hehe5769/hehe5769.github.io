<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆåœ¨åº«ãƒ»è²¡å‹™çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ  - Gemmaç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 1);
        }

        .badge-large {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-small {
            background-color: #dcfce7;
            color: #166534;
        }

        .total-banner {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen pb-12">

    <div class="max-w-5xl mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“¦ AIåœ¨åº«ãƒ»é‡‘é¡çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="text-gray-600">ãƒ­ãƒ¼ã‚«ãƒ«è‡ªå‹•ä¿å­˜ ï¼† CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾å¿œ</p>
        </header>

        <div class="glass-card rounded-2xl p-6 shadow-sm mb-8">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆå…¥åŠ›ï¼ˆéŸ³å£°æ–‡å­—èµ·ã“ã—ã‚„è‡ªç”±å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
                <button id="loadTestBtn"
                    class="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium px-3 py-1.5 bg-blue-50 rounded-lg border border-blue-100 transition-all hover:shadow-sm">
                    <span>ğŸ’¡</span> ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                </button>
            </div>
            <textarea id="aiInput" rows="4"
                class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="ä¾‹ï¼šé…¸èœ3æ¨½ï¼ˆå„42æ–¤ï¼‰ã€å˜ä¾¡50å††ã€‚å¤§ç‰ã®ã‚«ãƒƒãƒˆãªã—é…¸èœã‚’5æ¨½ã€å˜ä¾¡45å††..."></textarea>
            <div class="mt-4 flex flex-wrap gap-3 items-center justify-between">
                <div class="flex gap-2">
                    <button id="processBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <span id="btnText">AIã§è§£æãƒ»æ›´æ–°</span>
                        <div id="loader"
                            class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin">
                        </div>
                    </button>
                    <button id="clearInputBtn"
                        class="text-gray-500 hover:bg-gray-100 px-4 py-2.5 rounded-lg transition-colors">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-2xl shadow-sm overflow-hidden mb-6">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                <h2 class="text-xl font-bold text-gray-800">åœ¨åº«æ˜ç´°</h2>
                <div class="flex gap-2">
                    <button id="exportCsvBtn"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-md text-sm transition-colors flex items-center gap-1">CSVå‡ºåŠ›</button>
                    <button id="resetTableBtn"
                        class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-md text-sm transition-colors">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                        <tr>
                            <th class="px-6 py-4 font-semibold">å•†å“å</th>
                            <th class="px-6 py-4 font-semibold text-center">è¦æ ¼</th>
                            <th class="px-6 py-4 font-semibold">æ•°é‡ (æ¨½)</th>
                            <th class="px-6 py-4 font-semibold">å˜ä¾¡ (å††)</th>
                            <th class="px-6 py-4 font-semibold">å°è¨ˆ (å††)</th>
                            <th class="px-6 py-4 font-semibold text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div id="emptyState" class="py-12 text-center hidden">
                <p class="text-gray-400 text-lg">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>

        <div id="summaryCard" class="total-banner rounded-2xl p-6 text-white shadow-xl hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-semibold opacity-90">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆ</h3>
                    <p class="text-sm opacity-60">è‡ªå‹•ä¿å­˜ä¸­</p>
                </div>
                <div class="flex justify-center gap-12 border-x border-white/10">
                    <div class="text-center">
                        <div class="text-xs uppercase tracking-widest opacity-60 mb-1">å•†å“ç¨®åˆ¥</div>
                        <div id="totalTypes" class="text-3xl font-bold">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs uppercase tracking-widest opacity-60 mb-1">åˆè¨ˆæ•°é‡</div>
                        <div id="totalBuckets" class="text-3xl font-bold">0</div>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <div class="text-xs uppercase tracking-widest opacity-60 mb-1">ç·åˆè¨ˆé‡‘é¡ (JPY)</div>
                    <div class="text-4xl font-black text-yellow-400">
                        <span class="text-xl mr-1">Â¥</span><span id="totalAmount">0</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="statusMsg" class="mt-4 hidden p-4 rounded-xl text-center text-sm font-medium"></div>
    </div>

    <script>
        const apiKey = "AIzaSyD52sNOXplSIh2yS9QGbzWNymvcFwApkhE";
        const modelId = "gemma-3-27b-it";
        let inventory = JSON.parse(localStorage.getItem('inventoryData')) || {};

        const aiInput = document.getElementById('aiInput');
        const processBtn = document.getElementById('processBtn');
        const btnText = document.getElementById('btnText');
        const loader = document.getElementById('loader');
        const inventoryBody = document.getElementById('inventoryBody');
        const emptyState = document.getElementById('emptyState');
        const summaryCard = document.getElementById('summaryCard');
        const statusMsg = document.getElementById('statusMsg');

        function saveToLocal() { localStorage.setItem('inventoryData', JSON.stringify(inventory)); }

        async function analyzeTextWithAI(text) {
            const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®è²¡å‹™ãƒ»åœ¨åº«ç®¡ç†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æŠ½å‡ºé …ç›®ï¼šå“å(name), é‡é‡(weight), æ•°é‡(quantity), å˜ä¾¡(price)ã€‚ãƒ«ãƒ¼ãƒ«ï¼šå“åã«ã€Œå¤§ç‰ã€ã‚„ã€Œå¤§é¡†ã€ãŒå«ã¾ã‚Œã‚‹å ´åˆã€æœ«å°¾ã«ã€Œã€å¤§ç‰ã€‘ã€ã‚’ä»˜ä¸ã€‚å¿…ãšJSONé…åˆ—ã®ã¿è¿”å´ã€‚ä¾‹: [{"name":"ç„¡è‘‰é…¸èœ","weight":42,"quantity":3,"price":50}]ã€‚ãƒ†ã‚­ã‚¹ãƒˆï¼š${text}`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.1 } })
                });
                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const match = rawText.match(/\[\s*\{.*\}\s*\]/s);
                return match ? JSON.parse(match[0]) : null;
            } catch (e) { return null; }
        }

        function updateUI() {
            saveToLocal();
            const keys = Object.keys(inventory);
            if (keys.length === 0) {
                inventoryBody.innerHTML = ''; emptyState.classList.remove('hidden'); summaryCard.classList.add('hidden'); return;
            }
            emptyState.classList.add('hidden'); summaryCard.classList.remove('hidden');
            let totalBucketsVal = 0, totalAmountVal = 0;
            inventoryBody.innerHTML = keys.map(key => {
                const item = inventory[key];
                const subtotal = item.quantity * item.price;
                totalBucketsVal += item.quantity; totalAmountVal += subtotal;
                return `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4"><div class="font-bold text-gray-800">${item.name}</div><div class="text-xs text-gray-400">${item.weight}æ–¤/æ¨½</div></td>
                    <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${item.weight >= 40 ? 'badge-large' : 'badge-small'}">${item.weight >= 40 ? 'å¤§æ¨½' : 'å°æ¨½'}</span></td>
                    <td class="px-6 py-4"><input type="number" value="${item.quantity}" oninput="updateField('${key}', 'quantity', this.value)" class="w-16 border rounded px-2 py-1 outline-none"></td>
                    <td class="px-6 py-4"><input type="number" value="${item.price}" oninput="updateField('${key}', 'price', this.value)" class="w-24 border rounded px-2 py-1 outline-none"></td>
                    <td class="px-6 py-4 font-mono font-bold">Â¥${subtotal.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right"><button onclick="removeItem('${key}')" class="text-red-300 hover:text-red-500">å‰Šé™¤</button></td>
                </tr>`;
            }).join('');
            document.getElementById('totalTypes').textContent = keys.length;
            document.getElementById('totalBuckets').textContent = totalBucketsVal;
            document.getElementById('totalAmount').textContent = totalAmountVal.toLocaleString();
        }

        function updateField(key, field, val) {
            inventory[key][field] = parseFloat(val) || 0;
            const subtotal = inventory[key].quantity * inventory[key].price;
            event.target.closest('tr').querySelector('td:nth-child(5)').textContent = `Â¥${subtotal.toLocaleString()}`;
            refreshSummaryOnly();
            saveToLocal();
        }

        function refreshSummaryOnly() {
            let tb = 0, ta = 0;
            Object.values(inventory).forEach(i => { tb += i.quantity; ta += (i.quantity * i.price); });
            document.getElementById('totalBuckets').textContent = tb;
            document.getElementById('totalAmount').textContent = ta.toLocaleString();
        }

        function removeItem(key) { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { delete inventory[key]; updateUI(); } }

        function showStatus(msg, type) {
            statusMsg.textContent = msg; statusMsg.className = `mt-4 p-4 rounded-xl text-center text-sm block ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            setTimeout(() => statusMsg.classList.add('hidden'), 3000);
        }

        processBtn.addEventListener('click', async () => {
            const text = aiInput.value.trim();
            if (!text) return;

            // --- å…³é”®ä¿®æ”¹ï¼šç‚¹å‡»è¯†åˆ«æ—¶å…ˆæ¸…ç©ºå†…å­˜å’Œæœ¬åœ°ç¼“å­˜ ---
            inventory = {};
            localStorage.removeItem('inventoryData');
            updateUI();

            processBtn.disabled = true; loader.classList.remove('hidden'); btnText.textContent = 'è§£æä¸­...';
            const results = await analyzeTextWithAI(text);
            if (results) {
                results.forEach(item => {
                    const key = `${item.name}-${item.weight >= 40 ? 'L' : 'S'}`;
                    inventory[key] = item;
                });
                aiInput.value = ''; updateUI(); showStatus('è§£æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            }
            processBtn.disabled = false; loader.classList.add('hidden'); btnText.textContent = 'AIã§è§£æãƒ»æ›´æ–°';
        });

        document.getElementById('loadTestBtn').addEventListener('click', () => {
            aiInput.value = `å±±ç”° å¤ªéƒã€€090-1234-5678
ã€’150-0001 æ±äº¬éƒ½æ¸‹è°·åŒºç¥å®®å‰4-12-10
å°è‘‰é…¸èœã€€42æ–¤ã‚’3æ¨½ã€å˜ä¾¡50å††
å¤§ç‰é…¸èœã€€45æ–¤ã‚’5æ¨½ã€å˜ä¾¡60å††

ä½è—¤ èŠ±å­ã€€080-2345-6789
ã€’530-0001 å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°2-5-25
å°è‘‰é…¸èœã€€42æ–¤ã‚’2æ¨½ã€å˜ä¾¡50å††
è„†å£é…¸èœã€€20æ–¤ã‚’4æ¨½ã€å˜ä¾¡38å††

éˆ´æœ¨ ä¸€éƒã€€070-3456-7890
ã€’460-0008 æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­åŒºæ „3-18-1
å¤§ç‰å…åˆ‡é…¸èœã€€50æ–¤ã‚’6æ¨½ã€å˜ä¾¡55å††

é«˜æ©‹ ç¾å’²ã€€090-8765-4321
ã€’812-0011 ç¦å²¡çœŒç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…å‰1-9-3
å°è‘‰é…¸èœã€€42æ–¤ã‚’1æ¨½ã€å˜ä¾¡50å††
é…¸èåœã€€40æ–¤ã‚’2æ¨½ã€å˜ä¾¡45å††

ç”°ä¸­ å¥äºŒã€€080-9988-7766
ã€’980-0811 å®®åŸçœŒä»™å°å¸‚é’è‘‰åŒºä¸€ç•ªç”º4-7-12
è„†å£é…¸èœã€€20æ–¤ã‚’5æ¨½ã€å˜ä¾¡38å††`;

            showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¾ã—ãŸ', 'success');
        });

        document.getElementById('resetTableBtn').addEventListener('click', () => { if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { inventory = {}; updateUI(); } });
        document.getElementById('clearInputBtn').addEventListener('click', () => aiInput.value = '');

        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            let csv = "\uFEFFå•†å“å,é‡é‡,è¦æ ¼,æ•°é‡,å˜ä¾¡,å°è¨ˆ\n";
            Object.values(inventory).forEach(i => { csv += `"${i.name}",${i.weight},${i.weight >= 40 ? 'å¤§æ¨½' : 'å°æ¨½'},${i.quantity},${i.price},${(i.quantity * i.price)}\n`; });
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `åœ¨åº«_${new Date().toLocaleDateString()}.csv`; a.click();
        });

        updateUI();
    </script>
</body>

</html>